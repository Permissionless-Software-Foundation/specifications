# Multisig Approval

## Permissionless Software Foundation Specification 009 (PS009)

### Specification version: 1.0.0

### Date originally published: January 29, 2023

### Date last updated: January 29, 2023

## Authors

Chris Troutner

## 1. Introduction

This specification describes a workflow for generating on-chain 'approval' transactions from a multisignature wallet. The purpose of these approval transactions is to allow a group of people to securely broadcast their approval of a set of data, in way that can be independently verified, and thus impossible to counterfeit.

Doing *simple* transactions with a multisignature wallet is complex. Doing *complex* transactions with a multisignature wallet is often prohibitively complex. This specification proposes an alternative solution: Generate a complex transaction with a normal P2PKH tranaction, then broadcast an 'approval transaction' from a multisignature wallet. Armed with the normal transaction and the approval transaction, an entity can independently verify the authenticity of both.

The [pay-to-write database (**P2WDB**)](https://p2wdb.com) is used as the canonical use-case to present this workflow, but it can abstracted to any workflow where a council of members (a multisignature wallet) need to securely approve on-chain data.

The Permissionless Software Foundation (**PSF**) is a decentralized organization that maintains the P2WDB. Writing data to the P2WDB requires payment in [PSF tokens](https://psfoundation.cash). They have created a [Minting Council](https://psfoundation.info/governance/minting-council) to set the price of writes each quarter, targeting an equivalent price of $0.01 USD per write. They are required to approve a data update so that all P2WDB instances on the planet can sync and charge the same price.

## 2. Overview

There are two on-chain transactions generated in this workflow:

1. An **Update Transaction** is broadcast and contains an [IPFS](https://ipfs.io) content ID (**CID**) in the transaction OP_RETURN. The CID resolves into JSON data containing the arbitrary data, and all the metadata required to validate the the Approval Transaction. This is a standard P2PKH (single signature) transaction.

2. An **Approval Transaction** is generated from a P2SH multisignature wallet. It also contains OP_RETURN that contains the work 'APPROVAL' and the Transaction ID (**TXID**) of the Update Transaction.

Any entity can use the data in the Update Transaction to validate that the Approval Transaction is authentic, and was generated by the valid multisignature wallet. In this way, the two transaction reinforce and validate the other.

The multisignature wallet is generated from the public keys of members holding [SLP NFTs](https://github.com/simpleledger/slp-specifications/blob/master/slp-nft-1.md). This allows a group of NFT holders to approve on-chain data.

## 3. Update Transaction

The Update Transaction must contain an IPFS CID in it's OP_RETURN data. This CID should resolve to a JSON string. When parsed, the data should contain the following properties:

1. The token ID of the Group Token used to generate the NFTs.
2. The token IDs of each NFT, as well as the address and public key holding each NFT at the time of the transaction.
3. The multisig address generated from the public keys.
4. Any additional data the needs to be approved.

The first three pieces of information are used to validate the approval. The forth piece of data can be any arbitrary data, which is the subject of the approval.

## 4. Approval Transaction
The Approval Transaction must contain two pieces of information in its OP_RETURN data:

1. The word 'APPROVAL'. This makes it easy to parse and identify the transation as an Approval Transaction.
2. The TXID of the Update Transaction.

The Approval Transaction must include a dust output (546 satoshis) in its second (index 1) output to a **Reference Address**. The Reference Address can be any arbitrary BCH address, but it must be known to all parties.

## 5. Validation

Once the Approval Transaction is discovered by an interested entity (like an instance of the P2WDB), the chain of data can be followed to independently verify both transactions are valid and thus the arbitrary data in the Update Transaction is valid.

Here is the set up steps required to validate the authenticity of the data in the Update Transaction:

1. Request the transaction history for the Reference Address and sort the transactions in descending order by block height (most recent first).
2. Traverse the transaction history until one is found with the word 'APPROVAL' in the OP_RETURN data. This is the latest *Approval Transaction*. Note the address which generated the transaction, this is the *multisignature address*.
3. Retrieve the *Update Transaction* from the TXID stored in the OP_RETURN of the Approval Transaction.
4. Retrieve the CID from the OP_RETURN of the Update Transaction.
5. Retrieve the JSON data from an IPFS gateway, using the CID.
6. The following items in the JSON data should be validated:
  - Verify the Group token ID is listed and matches the expected value.
  - Verify that all NFTs listed are children of the given Group token.
  - Verify that each address listed is generated from the given public key.
  - Verify that each address holds the NFT listed.
    - Note: Since NFTs can move, it may be necessary to verify that the address *held* the NFT at some point in its transaction history.
  - Compute the multisignature address from the public keys and ensure it matches the address that generated the Approval Transaction.

After computing the above validations in step 6, the validator can be assured that the data is authentic and has not been counterfeited by a malicious party.
